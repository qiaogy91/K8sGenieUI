groups:
- name: 容器状态-监控告警
  rules:
    - alert: K8S容器短时间内多次重启
      annotations:
        summary: K8S容器短时间内多次重启
        message: '{{ $labels.cluster }} 集群容器组 {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container }}) 在10分钟内重启了 {{ printf "%.2f" $value }} 次！'
      expr: rate(kube_pod_container_status_restarts_total{job="kube-state-metrics"}[15m]) * 60 * 10 > 1
      for: 10m
      labels:
        level: 严重告警

    - alert: K8S容器组Terminated
      annotations:
        summary: K8S容器组Terminated
        message: '{{ $labels.cluster }} 集群容器组 {{ $labels.namespace }}/{{ $labels.pod }} Terminated 原因是 {{ $labels.reason }}！'
      expr: kube_pod_container_status_terminated_reason{reason!="Completed"} > 0
      for: 15m
      labels:
        level: 严重告警

    - alert: K8S容器组Completed
      annotations:
        summary: K8S容器组Completed
        message: '{{ $labels.cluster }} 集群容器组 {{ $labels.namespace }}/{{ $labels.pod }} Terminated 原因是 {{ $labels.reason }}！'
      expr: kube_pod_container_status_terminated_reason{reason="Completed"} > 0
      for: 15m
      labels:
        level: 严重告警

    - alert: K8S容器组Waiting
      annotations:
        summary: K8S容器组Waiting
        message: '{{ $labels.cluster }} 集群容器组 {{ $labels.namespace }}/{{ $labels.pod }} Waiting 原因是 {{ $labels.reason }}！'
      expr: |
        kube_pod_container_status_waiting_reason{reason!="ContainerCreating"} > 0
      for: 3m
      labels:
        level: 严重告警

    - alert: K8S容器组调度失败
      annotations:
        summary: K8S容器组调度失败
        message: '{{ $labels.cluster }} 集群容器组 {{ $labels.namespace }}/{{ $labels.pod }} 无符合预期工作节点，无法被调度！'
      expr: |
        sum by (cluster,pod) (kube_pod_status_unschedulable) > 0
      for: 5m
      labels:
        level: 严重告警
    - alert: K8S容器组NotReady
      annotations:
        summary: K8S容器组NotReady
        message: '{{ $labels.cluster }} 集群 {{ $labels.namespace }}/{{ $labels.pod }} 已处于 non-ready 状态超过15分钟！'
      expr: |
        sum by (namespace, pod, cluster) (max by(namespace, pod, cluster) (kube_pod_status_phase{job="kube-state-metrics", phase=~"Pending|Unknown"}) * on(namespace, pod, cluster) group_left(owner_kind) max by(namespace, pod, owner_kind, cluster) (kube_pod_owner{owner_kind!="Job"})) > 0
      for: 15m
      labels:
        level: 严重告警



    - alert: K8S部署实际副本数与预期数不匹配
      annotations:
        summary: 副本数不匹配
        message: '{{ $labels.cluster }} 集群部署 {{ $labels.namespace }}/{{ $labels.deployment }} 部署的实际副本数与预期数不匹配超过15分钟！'
      expr: |
        kube_deployment_spec_replicas{job="kube-state-metrics"}
          !=
        kube_deployment_status_replicas_available{job="kube-state-metrics"}
      for: 15m
      labels:
        level: 严重告警

    - alert: K8S容器组CPU Limits%使用率高
      annotations:
        summary: CPU Limits%使用率高
        message: '{{ $labels.cluster }} 集群命名空间 {{ $labels.namespace }} 的容器组 {{ $labels.pod }} 中的容器 {{ $labels.container }} CPU Limits %达到 {{ $value | humanizePercentage }} ！'
      expr: |
        sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_rate) by (container,pod,namespace,cluster) / sum(kube_pod_container_resource_limits_cpu_cores) by (container,pod,namespace,cluster) > 1
      for: 15m
      labels:
        level: 严重告警


    - alert: K8S容器组内存 Limits%使用率高
      annotations:
        summary: RAM Limits%使用率高
        message: '{{ $labels.cluster }} 集群命名空间 {{ $labels.namespace }} 的容器组 {{ $labels.pod }} 中的容器 {{ $labels.container }} 内存 Limits% 达到 {{ $value | humanizePercentage }} ！'
      expr: |
        sum(container_memory_working_set_bytes) by (container,pod,namespace,cluster) / sum(kube_pod_container_resource_limits_memory_bytes) by (container,pod,namespace,cluster) > 1
      for: 15m
      labels:
        level: 严重告警